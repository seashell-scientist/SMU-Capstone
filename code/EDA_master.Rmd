---
title: "Capstone"
author: "Jenna Ford, Christian Nava, Jonathan Tan"
date: "5/21/2020"
output:
  rmdformats::readthedown:
    highlight: kate
---

```{r setup, include=FALSE}
library(rmdformats)
library(tidyverse)  # data manipulaiton
library(data.table)
library(tswge)  # Time series package
library(tseries)  # for Dickey-Fuller test 
library(orcutt)  # for Cochrane-Orcutt test
library(formattable)  # for table formatting
library(GGally)
library(astsa)
library(nnfor)
library(dplyr)
library(ggplot2)
library(changepoint)
library(date)
library(R.devices)
knitr::opts_chunk$set(echo = TRUE,
               prompt = FALSE,
               tidy = TRUE,
               comment = NA,
               message = FALSE,
               warning = FALSE)
```

***
# Time Series Analysis of Corpus Christi Liquor Distribution
***
Jenna Ford, Christian Nava and Jonathan Tan  
May 21, 2020


## Read in Datasets and Combine
***
```{r data}
df_17_19 = read.csv("C:/Users/b007224/Documents/masters_in_data_science/capstone/data/Bivin CC 2017-19_updated_headings.csv")
df_15_16 = read.csv("C:/Users/b007224/Documents/masters_in_data_science/capstone/data/Bivin CC 2015-16_updated_headings.csv")
df_13_14 = read.csv("C:/Users/b007224/Documents/masters_in_data_science/capstone/data/Bivin CC 2013-14_updated_headings.csv")

dim(df_17_19)
dim(df_15_16)
dim(df_13_14)

#format date column
df_17_19$date = date.mmddyy(mdy.date(match(substr(df_17_19$Month, 1, 3),month.abb),01,df_17_19$Year),sep="/")
df_15_16$date = date.mmddyy(mdy.date(match(substr(df_15_16$Month, 4, 6),month.abb),01,df_15_16$Year),sep="/")
df_13_14$date = date.mmddyy(mdy.date(match(substr(df_13_14$Month, 1, 3),month.abb),01,df_13_14$Year),sep="/")

df <- rbind(df_17_19,df_15_16,df_13_14)

dim(df)
```

## Check for Missing Data
***
Here we create a function to check for missing data.
```{r missing}
check.for.missing.data <- function(data){
  a = colnames(data)
  b = colSums(is.na(df))  %>% as.data.table
  missing_value_table = cbind(a, b)
  colnames(missing_value_table) = c("Variables","Missing_values")
  missing_value_table = missing_value_table  %>% filter(Missing_values>0)  %>% 
                        mutate("As a % of Total Values" = round(100 * (Missing_values / nrow(df)), 1))  %>% 
                        arrange(desc(Missing_values))
  head(missing_value_table, 20)
}

table_a = check.for.missing.data(data=df)
# display table with first column aligned left all others aligned right
formattable(table_a, align = c("l", rep("r", NCOL(table_a) - 1)))
```

## Keep Only Active Accounts
***

```{r filter}
invisible(df %>% filter(Account_Status != "Closed"))
```

## Drop Variables
***

```{r drop}
drops <- c("Metrics","Year","Month","House","Account_Status","Beverage_Type","Fiscal_Year","Premise","Customer_Street_Address","Customer_City",
           "Customer_Zip_Code","Longitude_Customer","Latitude_Customer","Customer","Vendor","Brand_ID","Brand","Size","Product_ID","Chain","Category",
           "Product_Type_ID","Qty_Per_Case","Alcohol_Proof","X9L_Cases","Dollar_Sales_Per_Case","Dollar_Sales_Per_9L_Case")
df = df[ , !(names(df) %in% drops)]
```

## Variable Formatting
***

```{r formatting}
df$Dollar_Sales = as.numeric(gsub('[$,]', '', df$Dollar_Sales))
str(df)
```

## Products
***

```{r products}
product_type_group = df %>% group_by(Product_Type) %>% tally(sort=TRUE)
dim(product_type_group)
formattable(head(product_type_group), align = c("l", rep("r", NCOL(table_a) - 1)))

product_group = df %>% group_by(Product) %>% tally(sort=TRUE)
dim(product_group)
formattable(head(product_group), align = c("l", rep("r", NCOL(table_a) - 1)))

customer_group = df %>% group_by(Customer_ID) %>% tally(sort=TRUE)
dim(customer_group)
formattable(head(customer_group), align = c("l", rep("r", NCOL(table_a) - 1)))

product_type_product_group = df %>% group_by(Product_Type, Product) %>% tally(sort=TRUE)
dim(product_type_product_group)
formattable(head(product_type_product_group), align = c("l", rep("r", NCOL(table_a) - 1)))

all_group = df %>% group_by(Product_Type, Product, Customer_ID) %>% tally(sort=TRUE)
dim(all_group)
formattable(head(all_group), align = c("l", rep("r", NCOL(table_a) - 1)))
```

## Put Combinations for Forecasting into a Dataframe and Choose 10 Sample Combinations
***

```{r combinations}
# Create file with all possible combinations
combinations0 = as.data.frame(df %>% group_by(Product_Type, Product, Customer_ID) %>% tally(sort=TRUE))
combinations = combinations0 %>% filter(n >= 42)

# Sample combinations
set.seed(123)
sample_combinations = sample_n(combinations,10)
drops <- c("n")
sample_combinations = sample_combinations[ , !(names(sample_combinations) %in% drops)]
formattable(sample_combinations, align = c("l", rep("r", NCOL(table_a) - 1)))
```

## Time Series EDA & Forecasting
***

```{r eda1}
# Find data from file for first combination
all_dates = data.frame(date=c("1/1/2013","2/1/2013","3/1/2013","4/1/2013","5/1/2013","6/1/2013","7/1/2013","8/1/2013","9/1/2013","10/1/2013","11/1/2013","12/1/2013",
                              "1/1/2014","2/1/2014","3/1/2014","4/1/2014","5/1/2014","6/1/2014","7/1/2014","8/1/2014","9/1/2014","10/1/2014","11/1/2014","12/1/2014",
                              "1/1/2015","2/1/2015","3/1/2015","4/1/2015","5/1/2015","6/1/2015","7/1/2015","8/1/2015","9/1/2015","10/1/2015","11/1/2015","12/1/2015",
                              "1/1/2016","2/1/2016","3/1/2016","4/1/2016","5/1/2016","6/1/2016","7/1/2016","8/1/2016","9/1/2016","10/1/2016","11/1/2016","12/1/2016",
                              "1/1/2017","2/1/2017","3/1/2017","4/1/2017","5/1/2017","6/1/2017","7/1/2017","8/1/2017","9/1/2017","10/1/2017","11/1/2017","12/1/2017",
                              "1/1/2018","2/1/2018","3/1/2018","4/1/2018","5/1/2018","6/1/2018","7/1/2018","8/1/2018","9/1/2018","10/1/2018","11/1/2018","12/1/2018",
                              "1/1/2019","2/1/2019","3/1/2019","4/1/2019","5/1/2019","6/1/2019","7/1/2019","8/1/2019","9/1/2019","10/1/2019","11/1/2019","12/1/2019"))

date_combinations = merge(all_dates,sample_combinations,all=TRUE)
str(date_combinations)

# Join date/sample combinations with primary dataset to review records
temp = left_join(date_combinations,df)

# Replace missing values for STD_Cases and Dollar_Sales with zeros since no cases were sold those months
temp[is.na(temp)] <- 0
str(temp)

```

```{r sample1, eval=FALSE}
#only one sample combination
sample_combinations1 = sample_combinations[2,]
temp1 = inner_join(temp,sample_combinations1)
product = sample_combinations1$Product
customer = sample_combinations1$Customer_ID
product_type = sample_combinations1$Customer_ID

plot.ts(temp1$STD_Cases, 
        main=c(paste("Standard Case Sales of ", product), 
               paste("for ",customer)),
        xlab="Months",
        ylab="Standard Cases")

par(mfrow = c(2,2))
invisible(acf(temp1$STD_Cases, main="ACF"))
invisible(parzen.wge(temp1$STD_Cases))

invisible(acf(temp1$STD_Cases[0:length(temp1$date)/2], main="ACF for 1st Half of Series"))
invisible(acf(temp1$STD_Cases[(1+length(temp1$date)/2):length(temp1$date)], main="ACF for 2nd Half of Series"))

aic = aic5.wge(temp1$STD_Cases,type="aic")
aic

for (i in 1:5){
  if(aic[i,1] == 0 & aic[i,2] == 0){
    print("One of the top 5 models using BIC was an ARMA(0,0), indicating this series may be white noise.")
  }
  
}
test <- ts(temp1$STD_Cases[1:60])
model1 = invisible(aic.wge(test,type="aic"))
model1_est = invisible(est.arma.wge(test,p=model1$p,q=model1$q))
fore.arma.wge(test,phi = .888408, theta = .7637687, n.ahead = 9,plot=FALSE)
```

```{r loop}
results <- data.frame(Product_Type=integer(),
                      Product=character(),
                      Customer=integer(),
                      ljung_10=double(),
                      ljung_24=double(),
                      ljung_results=character(),
                      top_5_bic=character(),
                      EqualMeans_2_ASE=double(),
                      EqualMeans_3_ASE=double(),
                      EqualMeans_4_ASE=double(),
                      EqualMeans_5_ASE=double(),
                      EqualMeans_6_ASE=double(),
                      EqualMeans_7_ASE=double(),
                      EqualMeans_8_ASE=double(),
                      EqualMeans_9_ASE=double(),
                      EqualMeans_10_ASE=double(),
                      EqualMeans_11_ASE=double(),
                      EqualMeans_12_ASE=double(),
                      ARMA_2_ASE=double(),
                      ARMA_3_ASE=double(),
                      ARMA_4_ASE=double(),
                      ARMA_5_ASE=double(),
                      ARMA_6_ASE=double(),
                      ARMA_7_ASE=double(),
                      ARMA_8_ASE=double(),
                      ARMA_9_ASE=double(),
                      ARMA_10_ASE=double(),
                      ARMA_11_ASE=double(),
                      ARMA_12_ASE=double(),
                      ARIMA_2_ASE=double(),
                      ARIMA_3_ASE=double(),
                      ARIMA_4_ASE=double(),
                      ARIMA_5_ASE=double(),
                      ARIMA_6_ASE=double(),
                      ARIMA_7_ASE=double(),
                      ARIMA_8_ASE=double(),
                      ARIMA_9_ASE=double(),
                      ARIMA_10_ASE=double(),
                      ARIMA_11_ASE=double(),
                      ARIMA_12_ASE=double(),
                      ARIMA_S12_2_ASE=double(),
                      ARIMA_S12_3_ASE=double(),
                      ARIMA_S12_4_ASE=double(),
                      ARIMA_S12_5_ASE=double(),
                      ARIMA_S12_6_ASE=double(),
                      ARIMA_S12_7_ASE=double(),
                      ARIMA_S12_8_ASE=double(),
                      ARIMA_S12_9_ASE=double(),
                      ARIMA_S12_10_ASE=double(),
                      ARIMA_S12_11_ASE=double(),
                      ARIMA_S12_12_ASE=double(),
                      stringsAsFactors = FALSE)

# loop through sample combinations
for(i in 1:1) {
  sample_combinations1 = sample_combinations[i,]
  temp1 = inner_join(temp,sample_combinations1)
  product = sample_combinations1$Product
  customer = sample_combinations1$Customer_ID
  product_type = sample_combinations1$Customer_ID
  
  results[i,"Product_Type"] = product_type
  results[i,"Product"] = as.character(sample_combinations1$Product)
  results[i,"Customer"] = customer
  
  par(mfrow=c(1,1))
  plot.ts(temp1$STD_Cases, 
          main=c(paste("Standard Case Sales of ", product), 
                 paste("for Customer",customer)),
          xlab="Months",
          ylab="Standard Cases")
  
  par(mfrow = c(2,2))
  invisible(acf(temp1$STD_Cases, main="ACF"))
  invisible(parzen.wge(temp1$STD_Cases))

  invisible(acf(temp1$STD_Cases[0:length(temp1$date)/2], main="ACF for 1st Half of Series"))
  invisible(acf(temp1$STD_Cases[(1+length(temp1$date)/2):length(temp1$date)], main="ACF for 2nd Half of Series"))

  nulldev()
  ljung_10 = ljung.wge(temp1$STD_Cases,K=10)
  while (!is.null(dev.list()))  dev.off()
  cat("The Ljung-Box test with K=10 has a p-value of",ljung_10$pval,".")
  results[i,"ljung_10"] = ljung_10$pval
  
  nulldev()
  ljung_24 = ljung.wge(temp1$STD_Cases,K=24)
  while (!is.null(dev.list()))  dev.off()
  cat("The Ljung-Box test with K=24 has a p-value of",ljung_24$pval,".")
  results[i,"ljung_24"] = ljung_24$pval
  
  if (ljung_10$pval < .05 & ljung_24$pval < .05){
    print("Ljung-Box test results: At a significance level of 0.05, we reject the null hypothesis that this dataset is white noise.")
    results[i,"ljung_results"] = "not white noise"
  } else if (ljung_10$pval > .05 & ljung_24$pval < .05){
    print("Ljung-Box test results: At a significance level of 0.05, the test is inconclusive.")
    results[i,"ljung_results"] = "inconclusive"
  } else if (ljung_10$pval < .05 & ljung_24$pval > .05){
    print("Ljung-Box test results: At a significance level of 0.05, the test is inconclusive.")
    results[i,"ljung_results"] = "inconclusive"
  } else {
    print("Ljung-Box test results: At a significance level of 0.05, we fail to reject the null hypothesis that this dataset is white noise.")
    results[i,"ljung_results"] = "white noise"
  }
  
  sink("file")
  aic = invisible(aic5.wge(temp1$STD_Cases,type="bic"))
  sink()
  
 for (row in 1:nrow(aic)) {
    if(aic[row,1] == 0 & aic[row,2] == 0){
      print("One of the top 5 models using BIC was an ARMA(0,0), indicating this series may be white noise.")
      results[i,"top_5_bic"] = "white noise"
    }
 }

  #Equal Means Model
  for(j in 2:12) {
    trainingSize = 60
    ASEHolder = numeric()

    for( k in 1:(84-(trainingSize + j) + 1))
    {
      sink("file")
      model0_mean = mean(temp1$STD_Cases[k:(k+(trainingSize-1))])
      ASE = mean((temp1$STD_Cases[(trainingSize+k):(trainingSize+ k + j - 1)] - model0_mean)^2)
      ASEHolder[k] = (temp1$STD_Cases[(trainingSize+k):(trainingSize+ k + j - 1)] - model0_mean)^2
      sink()
      
      if (j==12) {
        assign(paste("EqualMeans_Results_",k,sep=""),(temp1$STD_Cases[(trainingSize+k):(trainingSize+ k + j - 1)] - model0_mean)^2)
      }
    }
    
    WindowedASE = mean(ASEHolder)
    results[i,paste0("EqualMeans_Results_",j,"_ASE")] = WindowedASE

  }

  #ARMA Model
  for(j in 2:12) {
    trainingSize = 60
    ASEHolder = numeric()
    
    for( k in 1:(84-(trainingSize + j) + 1))
    {
      sink("file")
      model1 = invisible(aic.wge(temp1$STD_Cases[k:(k+(trainingSize-1))],type="aic"))
      model1_est = invisible(est.arma.wge(temp1$STD_Cases[k:(k+(trainingSize-1))],p=model1$p,q=model1$q))
      forecasts = fore.aruma.wge(temp1$STD_Cases[k:(k+(trainingSize-1))],phi = model1_est$phi, theta = model1_est$theta, s = 0, d = 0,n.ahead = j,plot=FALSE)
      ASE = mean((temp1$STD_Cases[(trainingSize+k):(trainingSize+ k + j - 1)] - forecasts$f)^2)
      ASEHolder[k] = ASE
      sink()
      
      if (j==12) {
        assign(paste("ARMA_Results_",k,sep=""),(temp1$STD_Cases[(trainingSize+k):(trainingSize+ k + j - 1)] - forecasts$f)^2)
      }

    }
    
    WindowedASE = mean(ASEHolder)
    results[i,paste0("ARMA_",j,"_ASE")] = WindowedASE

  }
  
  #ARIMA Model with d=1
  nulldev()
  temp2 = artrans.wge(temp1$STD_Cases,1)
  dev.off()
  for(j in 2:12) {
    trainingSize = 60
    ASEHolder = numeric()
    
    for( k in 1:(84-(trainingSize + j) + 1))
    {
      sink("file")
      model1 = invisible(aic.wge(temp2[k:(k+(trainingSize-1-1))],type="aic"))
      model1_est = invisible(est.arma.wge(temp2[k:(k+(trainingSize-1-1))],p=model1$p,q=model1$q))
      forecasts = fore.aruma.wge(temp1$STD_Cases[k:(k+(trainingSize-1))],phi = model1_est$phi, theta = model1_est$theta, s = 0, d = 1,n.ahead = j,plot=FALSE)
      ASE = mean((temp1$STD_Cases[(trainingSize+k):(trainingSize+ k + j - 1)] - forecasts$f)^2)
      ASEHolder[k] = ASE
      sink()
      
      if (j==12) {
       assign(paste("ARIMA_Results_",k,sep=""),(temp1$STD_Cases[(trainingSize+k):(trainingSize+ k + j - 1)] - forecasts$f)^2)
      }
    }
    
    WindowedASE = mean(ASEHolder)
    results[i,paste0("ARIMA_",j,"_ASE")] = WindowedASE

  }
  
  #ARIMA Model with S=12
  nulldev()
  temp2 = artrans.wge(temp1$STD_Cases,phi.tr=c(rep(0,11),1))
  dev.off()
  for(j in 2:12) {
    trainingSize = 60
    ASEHolder = numeric()
    
    for( k in 1:(84-(trainingSize + j) + 1))
    {
      sink("file")
      model1 = invisible(aic.wge(temp2[k:(k+(trainingSize-1-12))],type="aic"))
      model1_est = invisible(est.arma.wge(temp2[k:(k+(trainingSize-1-12))],p=model1$p,q=model1$q))
      forecasts = fore.aruma.wge(temp1$STD_Cases[k:(k+(trainingSize-1))],phi = model1_est$phi, theta = model1_est$theta, s = 12, d = 0,n.ahead = j,plot=FALSE)
      ASE = mean((temp1$STD_Cases[(trainingSize+k):(trainingSize+ k + j - 1)] - forecasts$f)^2)
      ASEHolder[k] = ASE
      sink()
      
      if (j==12) {
       assign(paste("ARIMAS_Results_",k,sep=""),(temp1$STD_Cases[(trainingSize+k):(trainingSize+ k + j - 1)] - forecasts$f)^2)
      }
    }
    
    WindowedASE = mean(ASEHolder)
    results[i,paste0("ARIMA_S12_",j,"_ASE")] = WindowedASE

  }
  
  #graph ASEs for each Model
  EqualMeans_Results <- rbind(EqualMeans_Results_1,EqualMeans_Results_2,EqualMeans_Results_3,EqualMeans_Results_4,EqualMeans_Results_5,EqualMeans_Results_6,
                              EqualMeans_Results_7,EqualMeans_Results_8,EqualMeans_Results_9,EqualMeans_Results_10,EqualMeans_Results_11,EqualMeans_Results_12,
                              EqualMeans_Results_13)
  
  ARMA_Results <- rbind(ARMA_Results_1,ARMA_Results_2,ARMA_Results_3,ARMA_Results_4,ARMA_Results_5,ARMA_Results_6,ARMA_Results_7,ARMA_Results_8,
                       ARMA_Results_9,ARMA_Results_10,ARMA_Results_11,ARMA_Results_12,ARMA_Results_13)

  ARIMA_Results <- rbind(ARIMA_Results_1,ARIMA_Results_2,ARIMA_Results_3,ARIMA_Results_4,ARIMA_Results_5,ARIMA_Results_6,ARIMA_Results_7,ARIMA_Results_8,
                         ARIMA_Results_9,ARIMA_Results_10,ARIMA_Results_11,ARIMA_Results_12,ARIMA_Results_13)
      
  ARIMAS_Results <- rbind(ARIMAS_Results_1,ARIMAS_Results_2,ARIMAS_Results_3,ARIMAS_Results_4,ARIMAS_Results_5,ARIMAS_Results_6,ARIMAS_Results_7,ARIMAS_Results_8,
                          ARIMAS_Results_9,ARIMAS_Results_10,ARIMAS_Results_11,ARIMAS_Results_12,ARIMAS_Results_13)
      
  EqualMeans_Means <- colMeans(EqualMeans_Results)
  ARMA_Means <- colMeans(ARMA_Results)
  ARIMA_Means <- colMeans(ARIMA_Results)
  ARIMAS_Means <- colMeans(ARIMAS_Results)
  Combined_Means <- data.frame(EqualMeans_Means,ARMA_Means, ARIMA_Means, ARIMAS_Means)
  Combined_Means$horizon <- as.numeric(row.names(Combined_Means))
  
  sink()
  dev.off()
  sink()
  par(mfrow = c(1,1))
  ggplot(data=Combined_Means, aes(horizon)) + 
    geom_line(aes(y=EqualMeans_Means, color="Equal Means"),size=1.5) +
    geom_line(aes(y=ARMA_Means, color="ARMA"),size=1.5) +
    geom_line(aes(y=ARIMA_Means, color="ARIMA"),size=1.5) +
    geom_line(aes(y=ARIMAS_Means, color="ARIMAS"),size=1.5) +
    scale_color_manual(values = c(
      'Equal Means' = '#58508d',
      'ARMA' = '#bc5090',
      'ARIMA' = '#ff6361',
      'ARIMAS' = '#ffa600'
    )) +
    labs(color='Models') +
    scale_x_continuous(breaks=seq(0,13,1)) +
    ggtitle(paste("Model ASEs for ", product,"and Customer",customer)) +
    xlab("Month Ahead Forecast") +
    ylab("ASE") +
    theme(panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.title = element_blank())
}

formattable(results, align = c("l", rep("r", NCOL(table_a) - 1)))
```